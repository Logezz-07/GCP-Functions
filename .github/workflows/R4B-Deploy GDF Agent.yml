name: R4B-Deploy GDF Agent

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select Environment To Restore"
        required: true
        type: choice
        options:
          - Dev
          - QA
          - Prod

      agent_display_name:
        description: "Agent Name To Restore (Eg: R4B-IVA-**)"
        required: true
        type: string

      git_tag:
        description: "Git Tag To Checkout (Eg: GDF-Dev-v**)"
        required: true

jobs:
  restore-agent:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    env:
      PROJECT_ID: ${{ vars.PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      AGENT_DISPLAY_NAME: ${{ github.event.inputs.agent_display_name }}

    steps:
      # Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_tag }}

      # Validate Agent 
      - name: Validate Agent 
        run: |
          echo "üîç Checking: ConversationalAgents/${AGENT_DISPLAY_NAME}"
          if [ ! -d "ConversationalAgents/${AGENT_DISPLAY_NAME}" ]; then
            echo "‚ùå ERROR: Agent does NOT exist."
            echo "üìÇ Available agents:"
            ls ConversationalAgents/
            exit 1
          fi
          echo "‚úÖ Agent found."

      # Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Install cxcli globally
      - name: Install cxcli globally
        run: |
          echo "‚¨áÔ∏è Installing cxcli..."
          curl -L -o cxcli.tar.gz https://github.com/xavidop/dialogflow-cx-cli/releases/download/v1.239.0/cxcli_Linux_x86_64.tar.gz
          tar -xzf cxcli.tar.gz
          sudo mv cxcli /usr/local/bin/
          cxcli version
          echo "‚úÖ cxcli installed successfully."

      # Build agent.zip
      - name: Build agent.zip
        working-directory: ConversationalAgents
        run: |
          echo "üì¶ Building agent.zip..."
          zip -r agent.zip "${AGENT_DISPLAY_NAME}" \
            -x ".git/*" \
            -x ".github/*" \
            -x "*.zip"
          echo "‚úÖ agent.zip created."

      # Restore Dialogflow CX Agent
      - name: Restore Dialogflow CX Agent
        working-directory: ConversationalAgents
        run: |
          echo "üöÄ Restoring Dialogflow CX Agent..."
          echo "üìç PROJECT: ${PROJECT_ID}, REGION: ${REGION}, AGENT: ${AGENT_DISPLAY_NAME}"

          cxcli agent restore "${AGENT_DISPLAY_NAME}" \
            --project-id "${PROJECT_ID}" \
            --location-id "${REGION}" \
            --input "agent.zip" \
            --output-format json \
            --verbose

          echo "‚úÖ Restore completed successfully."