name: R4B-Deploy Node Package

on:
  workflow_dispatch:
    inputs:
      git_tag:
        description: "Git tag or commit to checkout"
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout the repo at the specified Git tag
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_tag }}

      # 2ï¸âƒ£ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # 3ï¸âƒ£ Publish the NodeModules package
      - name: Publish NodeModules to Artifact Registry
        working-directory: NodeModules
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "ğŸš€ Setting up npm authentication..."
          # Create temporary .npmrc with runtime secret
          echo "@roger:registry=https://us-central1-npm.pkg.dev/roger-470808/r4b-common-nodemodules/" > .npmrc
          echo "//us-central1-npm.pkg.dev/roger-470808/r4b-common-nodemodules/:_password=${NPM_TOKEN}" >> .npmrc
          echo "//us-central1-npm.pkg.dev/roger-470808/r4b-common-nodemodules/:username=_json_key_base64" >> .npmrc
          echo "//us-central1-npm.pkg.dev/roger-470808/r4b-common-nodemodules/:email=not.valid@email.com" >> .npmrc
          echo "//us-central1-npm.pkg.dev/roger-470808/r4b-common-nodemodules/:always-auth=true" >> .npmrc
          echo "ğŸš€ Publishing NodeModules package..."
          npm publish
          # Clean up the temporary .npmrc
          rm -f .npmrc