name: R4B-Deploy Node Package

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment to deploy"
        required: true
        type: choice
        options:
          - Dev
          - QA
          - Prod
      git_tag:
        description: "Git tag or commit to checkout"
        required: true

jobs:
  Publish-Node-Package:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      # Validate Git Tag
      - name: Validate Git Tag
        run: |
          ENVIRONMENT="${{ github.event.inputs.environment }}"
            TAG="${{ github.event.inputs.git_tag }}"
            EXPECTED_PREFIX="NodeModules-${ENVIRONMENT}-v"

          if echo "$TAG" | grep -Eq "^${EXPECTED_PREFIX}[0-9]+$"; then
            echo "âœ”ï¸ The provided deployment tag - '$TAG' aligns with the selected $ENVIRONMENT environment."
          else
            echo "âŒ ERROR: The tag '$TAG' does not match the expected naming convention for the '$ENVIRONMENT' environment."
             exit 1
          fi
      # Checkout repo
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.git_tag }}

      # Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # Publish NodeModules package
      - name: Publish NodeModules to Artifact Registry
        working-directory: CommonNodeModules
        env:
          PROJECT_ID: ${{ vars.PROJECT_ID }}
          REGION: ${{ vars.REGION }}
          NPM_PASSWORD: ${{ secrets.NPM_PASSWORD }}
        run: |
          echo "ðŸ”¹ Registry URL: https://${{ vars.REGION }}-npm.pkg.dev/${{ vars.PROJECT_ID }}/r4b-common-nodemodules/"
          echo "ðŸš€ Setting up npm authentication..."
          echo "@roger:registry=https://$REGION-npm.pkg.dev/$PROJECT_ID/r4b-common-nodemodules/" > .npmrc
          echo "//$REGION-npm.pkg.dev/$PROJECT_ID/r4b-common-nodemodules/:_password=${NPM_PASSWORD}" >> .npmrc
          echo "//$REGION-npm.pkg.dev/$PROJECT_ID/r4b-common-nodemodules/:username=_json_key_base64" >> .npmrc
          echo "//$REGION-npm.pkg.dev/$PROJECT_ID/r4b-common-nodemodules/:email=not.valid@email.com" >> .npmrc
          echo "//$REGION-npm.pkg.dev/$PROJECT_ID/r4b-common-nodemodules/:always-auth=true" >> .npmrc

          echo "ðŸš€ Publishing NodeModules package..."
          npm publish

      # Cleanup .npmrc (always run)
      - name: Cleanup .npmrc
        if: always()
        run: rm -f CommonNodeModules/.npmrc
