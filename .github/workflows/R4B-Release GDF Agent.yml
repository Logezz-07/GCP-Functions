name: R4B-Release GDF Agent

on:
  push:
    branches:
      - Dev
      - QA
      - Prod
    paths:
      - "ConversationalAgents/**"

jobs:
  Release-Agent:
    name: Release-Agent on â€“ ${{ github.ref_name }}
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name }}

    env:
      PROJECT_ID: ${{ vars.PROJECT_ID }}
      REGION: ${{ vars.REGION }}
      ENVIRONMENT: ${{ github.ref_name }}

    steps:
      # Checkout repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Configure Git
      - name: Configure Git
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      # Auto-discover agents and update webhook URLs
      - name: Update Webhook URLs
        run: |
          echo "ğŸ” Searching for ConversationalAgents/*/webhooks folders..."

          for agent in ConversationalAgents/*; do
            if [ -d "$agent/webhooks" ]; then
              echo "ğŸ“ Found agent: $agent"

              for file in "$agent/webhooks"/*.json; do
                filename=$(basename "$file" .json)
                function_name=$(echo "$filename" | tr '[:upper:]' '[:lower:]')
                webhook_url="https://${REGION}-${PROJECT_ID}.cloudfunctions.net/${function_name}"

                echo "  â†³ Updating $filename â†’ $webhook_url"
                jq --arg url "$webhook_url" \
                   '.genericWebService.uri = $url' \
                   "$file" > tmp.json && mv tmp.json "$file"
              done

            else
              echo "âš ï¸ No webhooks directory in: $agent â€” skipping"
            fi
          done

      # Commit and push updates
      - name: Commit and Push Updates
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸš€ Committing webhook updates for ${ENVIRONMENT}..."
          git add ConversationalAgents/*/webhooks/*.json
          git commit -m "Auto-updated webhook URLs for ${ENVIRONMENT}" || echo "No changes to commit"
          git push origin ${ENVIRONMENT}
          echo "âœ… Webhook updates pushed successfully."

      # Determine tag prefix
      - name: Set Tag Prefix
        id: prefix
        run: |
          BRANCH_NAME=${GITHUB_REF##*/}
          if [ "$BRANCH_NAME" == "Dev" ]; then
            echo "prefix=GDF-Dev" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "QA" ]; then
            echo "prefix=GDF-QA" >> $GITHUB_OUTPUT
          elif [ "$BRANCH_NAME" == "Prod" ]; then
            echo "prefix=GDF-Prod" >> $GITHUB_OUTPUT
          else
            echo "âŒ Unknown branch: $BRANCH_NAME"
            exit 1
          fi

      # Generate next tag version
      - name: Generate Next Tag
        id: version
        run: |
          PREFIX=${{ steps.prefix.outputs.prefix }}
          LAST_TAG=$(git tag --list "${PREFIX}-v*" | sort -V | tail -n 1)

          if [ -z "$LAST_TAG" ]; then
            NEXT_VERSION="${PREFIX}-v1"
          else
            VERSION_NUM=$(echo "$LAST_TAG" | grep -oE '[0-9]+$')
            NEXT_VERSION="${PREFIX}-v$((VERSION_NUM + 1))"
          fi

          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ· Next Tag: $NEXT_VERSION"

      # Create and Push Tag
      - name: Create and Push Tag
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.version.outputs.version }}
          git push origin ${{ steps.version.outputs.version }}
          echo "ğŸ· Tag pushed: ${{ steps.version.outputs.version }}"
