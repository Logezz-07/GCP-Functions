name: pushToReleaseBranch

on:
  workflow_dispatch:

jobs:
  syntax-check-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout Dev Branch
      - name: Checkout Code
        uses: actions/checkout@v3
        with:
          ref: dev
          fetch-depth: 0

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Install Dependencies
      - name: Install Dependencies
        run: npm ci

      # 4️⃣ Run TypeScript Syntax Check
      - name: Run TypeScript Syntax Check
        run: |
          npm run check-syntax
          echo "✅ TypeScript syntax check completed successfully!"

      # 5️⃣ Push to Release Branch with Tag (only if changes in FUNCTIONS_LIST)
      - name: Push to Release Branch with Tag
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FUNCTIONS_LIST: ${{ secrets.FUNCTIONS_LIST }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          echo "🚀 Fetching remote branches..."
          git fetch origin dev
          git fetch origin release

          # Convert comma-separated FUNCTIONS_LIST to space-separated
          FUNCTIONS_LIST=$(echo "$FUNCTIONS_LIST" | tr ',' ' ')
          echo "🔍 Checking for changes in functions: $FUNCTIONS_LIST"

          CHANGED_FUNCS=()

          # Check for changes in each function folder
          for func in $FUNCTIONS_LIST; do
            if ! git diff --quiet origin/release..origin/dev -- "$func"; then
              echo "⚡ Changes detected in $func"
              CHANGED_FUNCS+=("$func")
            else
              echo "✅ No changes in $func"
            fi
          done

          # Switch to release branch
          git checkout -B release origin/release

          if [ ${#CHANGED_FUNCS[@]} -gt 0 ]; then
            echo "🔀 Merging changed functions from dev into release..."
            for func in "${CHANGED_FUNCS[@]}"; do
              echo "📂 Merging updates for: $func"
              git checkout origin/dev -- "$func"
            done

            echo "📦 Staging updated folders..."
            git add "${CHANGED_FUNCS[@]}"

            echo "💾 Committing merged changes..."
            git commit -m "Merged changes from dev into release for: ${CHANGED_FUNCS[*]}" || echo "ℹ️ Nothing new to commit"

            echo "⬆️ Pushing release branch..."
            git push origin release --force

            echo "🏷 Generating new version tag..."
            LATEST_TAG=$(git tag --list "R4B-Function-v*" --sort=-v:refname | head -n1)
            if [ -z "$LATEST_TAG" ]; then
              NEXT_VERSION=1
            else
              NUM=$(echo $LATEST_TAG | sed 's/R4B-Function-v//')
              NEXT_VERSION=$((NUM + 1))
            fi

            VERSION="R4B-Function-v$NEXT_VERSION"
            git tag $VERSION
            git push origin $VERSION
            echo "✅ Tag $VERSION created and pushed successfully!"
          else
            echo "ℹ️ No changes detected in any function folder. Skipping commit and version increment."
            LATEST_TAG=$(git tag --list "R4B-Function-v*" --sort=-v:refname | head -n1)
            VERSION=$LATEST_TAG
            echo "🏷 Current version remains: $VERSION"
          fi

          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
