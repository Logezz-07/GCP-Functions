import { Storage } from "@google-cloud/storage";
import * as logger from "./logger.js";
import csv from "csvtojson";

const storage = new Storage();
const BUCKET_NAME = process.env.GCS_BUCKET_NAME;
const NLU_CONFIG_PATH = process.env.GCS_NLU_CONFIG_PATH;
const NLU_CONFIG_KEY = process.env.GCS_NLU_CONFIG_KEY;

let cachedNluConfig = null;
let nluConfigEtag = null;

async function preloadNluConfig({ sessionId, tag }) {
  try {
    const file = storage.bucket(BUCKET_NAME).file(NLU_CONFIG_PATH);
    const metaStart = Date.now();
    const [metadata] = await file.getMetadata();
    const metaTime = Date.now() - metaStart;
    logger.logConsole(sessionId, tag, `Metadata fetched in ${metaTime} ms (etag=${metadata.etag})`);
    if (cachedNluConfig && nluConfigEtag === metadata.etag) {
      logger.logConsole(sessionId, tag, "NLU config already cached");
      return;
    }
    const downloadStart = Date.now();
    const [contents] = await file.download();
    const downloadTime = Date.now() - downloadStart;
    logger.logConsole(sessionId, tag, `File downloaded in ${downloadTime} ms`);
    const csvText = contents.toString();
    const jsonArray = await csv().fromString(csvText);

    cachedNluConfig = jsonArray;
    nluConfigEtag = metadata.etag;

    logger.logConsole(
      sessionId,
      tag,
      `NLU config updated in cache (${jsonArray.length} rows)`
    );

  } catch (err) {
    logger.logErrorResponse({ sessionId, tag, attemptCount: 1, err });
  }
}


async function getNluConfigByKey({ sessionId, tag, key }) {

  if (!cachedNluConfig) {
    logger.logConsole(sessionId, tag, "NLU cache empty, preloading...");
    await preloadNluConfig({ sessionId, tag });
  }

  const filtered = cachedNluConfig?.filter(row => row[NLU_CONFIG_KEY] == key) || [];

  if (filtered.length === 0) {
    logger.logConsole(sessionId, tag, `NLU key "${key}" not found`);
    return {
      Status: 404,
      ReturnCode: "1",
      ResponsePayload: { message: "Config key not found" }
    };
  }
  return {
    Status: 200,
    ReturnCode: "0",
    ResponsePayload: filtered[0]
  };
}

export { getNluConfigByKey, preloadNluConfig };